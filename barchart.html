<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <style>
    .bar {
      fill: steelblue;
    }

    .bar:hover {
      fill: brown;
    }
    </style>
    <meta charset="utf-8">
    <title>Bar Chart</title>
    <script src="https://d3js.org/d3.v5.js"></script>
  </head>
  <body>
    <select id="selectButton">Hello</select>
    <svg></svg>
    <script type="text/javascript">

      function groupby(data, key, value) {
        let stored = []
        let map = {}
        let altered_data = []

        data.forEach((item, i) => {
          if (! stored.includes(item[key])) {
            map[item[key]] = []
            stored.push(item[key])
          }

          map[item[key]].push(parseFloat(item[value]));
        });

        for (var k in map) {
          altered_data.push({
            "key": k,
            "value":  map[k].reduce(function(a,b){ return a + b }) / map[k].length
          });
        }

        return altered_data;
      }

      function getKeys(data){
        let aList = [];
        data.forEach((item, i) => {
          aList.push(item["key"])
        });
        return aList;
      }

      function alterDisplay(data){
        let x = d3.scaleBand()
                  .rangeRound([0, width])
            	    .padding(0.1)
                  .domain(getKeys(data));

        let y = d3.scaleLinear()
                  .rangeRound([height, 0])
                  .domain([0, d3.max(data, function (d) { return d["value"]})]);

        g.append("g")
         .attr("transform", "translate(0," + height + ")")
         .call(d3.axisBottom(x))
         .selectAll("text")
         .attr("transform", "translate(0, 20)");

       g.append("g")
   	    .call(d3.axisLeft(y))
   	    .append("text")
   	    .attr("fill", "#000")
   	    .attr("transform", "translate(20, 20) rotate(-90)")
   	    .attr("y", 6)
   	    .attr("dy", "1px")
        .attr("text-anchor", "end")
        .text("Extinction Frequency");

      var bar = g.selectAll(".bar")
                 .data(data)
                 .enter()
                 .append("rect")
                 .attr("class", "bar")
                 .attr("x", function(d) { return x(d["key"]); })
                 .attr("width", x.bandwidth())
                 .attr("y", function(d) { return y(d["value"]); })
                 .attr("height", function(d) { return height - y(d["value"]) });

      }
      function display(data) {

        var new_data = groupby(data.bio, "Geographic region", "Ext.Freq");
        alterDisplay(new_data)


        const options = ["Geographic region", "Locality"];
        d3.select("#selectButton")
          .selectAll('myOptions')
          .data(options)
          .enter()
          .append('option')
          .text(function (d) { return d })
          .attr("value", function (d) { return d });

        d3.select("#selectButton").on("change", function(d) {
          var selectedOption = d3.select(this).property("value")
          var new_data = groupby(data.bio, selectedOption, "Ext.Freq");
          g.selectAll("*").remove();
          alterDisplay(new_data);
          });

        var new_data = groupby(data.bio, "Geographic region", "Ext.Freq");

      }

      var svg = d3.select("svg")
                  .attr("width", 1024)
                  .attr("height", 512);

      var margin = {"top": 100, "bottom": 100, "left": 100, "right": 100};
      var width = + svg.attr("width") - (margin.left + margin.right);
      var height = + svg.attr("height") - (margin.top + margin.bottom);

      var g = svg.append("g")
                 .attr("transform", "translate(" + margin.left + "," + 0 + ")");

      d3.json("data.json").then(display);

    </script>

  </body>
</html>
