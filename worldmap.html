<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Map</title>
    <script src="https://d3js.org/d3.v5.js"></script>
  </head>
  <body>
    <select id='selectButton1'>Worldmap Selection</select>
    <svg></svg>
    <script>

      // intialize svg width and height
      const  width = 1024;
      const height = 512;

      var svg = d3.select("svg")
                  .attr("id", "svgMap")
                  .attr("width", width)
                  .attr("height", height)
                  .style("background-color", "b3d9ff");

      // Projection for map
      var projection = d3.geoMercator()
                         .scale(150)
                         .center([0,40])
                         .translate([width / 2, height / 2]);

      Promise.all([
          d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"),
          d3.json("data.json"),
          d3.json("climate_data.json")
        ]
      ).then(mapView)

      function mapView(values) {

        console.log("Loading page....")

        // intialize data variables
        var worldmap = values[0];
        var data = values[1];
        var climate_data = values[2];



        // Add map
        svg.append("g")
           .selectAll("path")
           .data(worldmap.features)
           .enter()
           .append("path")
           .attr("d", d3.geoPath().projection(projection))
           .attr("fill", "#ffffe6");

        // add coordinates for all sites
        var allSites = svg.append("g")
                          .selectAll("circle")
                          .data(data.location)
                          .enter()
                          .append("circle")
                          .attr("cx", function(d){ return projection([d.Longitude, d.Latitude])[0] })
                          .attr("cy", function(d){ return projection([d.Longitude, d.Latitude])[1] })
                          .attr("r", "1.5px")
                          .attr("fill", "red");

        // zoom
        var zoom = d3.zoom()
                     .scaleExtent([1, 8])
                     .on('zoom', function() {
                       svg.selectAll("g")
                          .attr('transform', d3.event.transform);
                      });

        svg.call(zoom);

        const options = {
          "Average Temperature": "meanTemp",
          "Average Percipitation": "meanPerc"
        };

        selectionView(climate_data, options["Average Temperature"])

        d3.select("#selectButton1")
          .selectAll('myOptions')
          .data(Object.keys(options))
          .enter()
          .append('option')
          .text(function (d) { return d })
          .attr("value", function (d) { return d });

        d3.select("#selectButton1")
          .on("change", function(d) {
            var selectedOption = d3.select(this).property("value")
            d3.select("#info").remove();
            selectionView(climate_data, options[selectedOption]);
          });
      }

      function selectionView(data, selectedOption) {
        console.log(selectedOption);

        let tempScale = d3.scaleLinear()
                          .domain([-5, 40])
                          .range([5, 50]);
        let tempColorScale = d3.scaleSequential(d3.interpolateMagma)
                               .domain([-20, 40])

        let percScale = d3.scaleLinear()
                          .domain([0, 4000])
                          .range([5, 50]);

        let percColorScale = d3.scaleSequential(d3.interpolateBlues)
                               .domain([0, 4000])


        var siteBioInfo = svg.append("g")
                          .attr("id", "info")
                          .selectAll("circle")
                          .data(data)
                          .enter()
                          .append("circle")

                          .attr("cx", function(d){ return projection([d.longitude, d.latitude])[0] })
                          .attr("cy", function(d){ return projection([d.longitude, d.latitude])[1] })
                          .style("opacity", 0.2);
        if (selectedOption == "meanTemp"){
          siteBioInfo.attr("r", function(d){ return tempScale(d.historical[selectedOption])})
                     .attr("fill", function(d){ return tempColorScale(d.historical[selectedOption])});
        }
        else{
          siteBioInfo.attr("r", function(d){ return percScale(d.historical[selectedOption])})
                     .attr("fill", function(d){ return percColorScale(d.historical[selectedOption])});
        }



      }

</script>


  </body>
</html>
